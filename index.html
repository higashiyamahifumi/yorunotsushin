<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Busy Tone</title>
  <style>
    body{margin:0;height:100vh;display:grid;place-items:center;background:#0b0c10;color:#e7e7e7;font-family:system-ui,sans-serif;}
    button{width:min(520px,92vw);height:220px;font-size:28px;border-radius:18px;border:1px solid #333;background:#e7e7e7;color:#000;}
    .hint{margin-top:14px;opacity:.75;font-size:13px;line-height:1.6;text-align:center;}
  </style>
</head>
<body>
  <div style="text-align:center;">
    <button id="pad">PRESS & HOLD</button>
    <div class="hint">押してる間だけ「ツーツー（話中音）」が鳴ります。</div>
  </div>

<script>
let ctx, o1, o2, gain, filter;
let timer = null;
let isHolding = false;

function ensureAudio(){
  if (ctx) return;

  ctx = new (window.AudioContext || window.webkitAudioContext)();

  // 2音ミックス
  o1 = ctx.createOscillator();
  o2 = ctx.createOscillator();
  o1.type = "sine";
  o2.type = "sine";

  // ★ここが話中音のキャラ（定番の組み合わせ）
  // 480 + 620 が“それっぽい”ことが多い。違う国/機種っぽくしたければここをいじる。
  o1.frequency.value = 480;
  o2.frequency.value = 620;

  gain = ctx.createGain();
  gain.gain.value = 0.0; // 最初は無音

  // ちょい電話回線っぽく（高域/低域を削る）
  filter = ctx.createBiquadFilter();
  filter.type = "bandpass";
  filter.frequency.value = 1500;
  filter.Q.value = 0.7;

  o1.connect(gain);
  o2.connect(gain);
  gain.connect(filter);
  filter.connect(ctx.destination);

  o1.start();
  o2.start();
}

function rampTo(value, t=0.02){
  const now = ctx.currentTime;
  gain.gain.cancelScheduledValues(now);
  gain.gain.setValueAtTime(gain.gain.value, now);
  gain.gain.linearRampToValueAtTime(value, now + t);
}

// ★断続パターン：0.5秒ON / 0.5秒OFF（ツーツー）
function startBusyLoop(){
  if (timer) return;

  let on = false;
  const step = () => {
    if (!isHolding) return;
    on = !on;

    if (on) rampTo(0.18, 0.01);  // ON音量
    else    rampTo(0.0,  0.03);  // OFF（クリック減らし気味）

    timer = setTimeout(step, 500); // ★ここで速さ調整
  };

  step();
}

function stopBusyLoop(){
  if (timer){
    clearTimeout(timer);
    timer = null;
  }
  if (ctx) rampTo(0.0, 0.05);
}

function onHold(){
  ensureAudio();
  ctx.resume();
  isHolding = true;
  startBusyLoop();
}

function offHold(){
  isHolding = false;
  stopBusyLoop();
}

const pad = document.getElementById("pad");

// mouse
pad.addEventListener("mousedown", (e)=>{ e.preventDefault(); onHold(); });
window.addEventListener("mouseup", ()=> offHold());

// touch
pad.addEventListener("touchstart", (e)=>{ e.preventDefault(); onHold(); }, {passive:false});
pad.addEventListener("touchend",   (e)=>{ e.preventDefault(); offHold(); }, {passive:false});
pad.addEventListener("touchcancel",(e)=>{ e.preventDefault(); offHold(); }, {passive:false});

window.addEventListener("blur", ()=> offHold());
document.addEventListener("visibilitychange", ()=>{ if (document.hidden) offHold(); });
</script>
</body>
</html>
